generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Authentication & Users
// ============================================

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  name          String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  memberships ProjectMember[]
  sent_invitations ProjectInvitation[]

  @@map("users")
}

// ============================================
// Projects & Teams
// ============================================

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  members  ProjectMember[]
  channels SocialChannel[]
  weeks    Week[]
  posts    Post[]
  settings ProjectSettings[]
  invitations ProjectInvitation[]

  @@map("projects")
  
  prompt_presets PromptPreset[]
  comments       Comment[]
  provider_keys  ProviderKey[]
  telegram_accounts TelegramAccount[]
}

model ProjectMember {
  id         Int      @id @default(autoincrement())
  project_id Int
  user_id    Int
  role       String // "owner", "editor", "viewer"
  created_at DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@map("project_members")
}

model ProjectInvitation {
  id         Int      @id @default(autoincrement())
  project_id Int
  email      String
  role       String   @default("viewer")
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  created_by Int

  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  creator    User     @relation(fields: [created_by], references: [id], onDelete: Cascade)

  @@map("project_invitations")
  @@index([email])
  @@index([token])
}

model ProjectSettings {
  id         Int      @id @default(autoincrement())
  project_id Int
  key        String
  value      String
  updated_at DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, key])
  @@map("project_settings")
}

// ============================================
// Social Media Channels
// ============================================

model SocialChannel {
  id         Int      @id @default(autoincrement())
  project_id Int
  type       String // "telegram", "vk", "instagram", "twitter", "linkedin"
  name       String
  config     Json // Platform-specific configuration
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  posts   Post[]

  @@map("social_channels")
}

// ============================================
// Content Planning
// ============================================

model Week {
  id            Int      @id @default(autoincrement())
  project_id    Int
  week_start    DateTime @db.Date
  week_end      DateTime @db.Date
  theme         String
  status        String
  regen_attempt Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  posts   Post[]

  @@unique([project_id, week_start, week_end])
  @@map("weeks")
}

model Post {
  id                  Int      @id @default(autoincrement())
  project_id          Int
  week_id             Int
  channel_id          Int? // Which social channel to publish to
  slot_date           DateTime @db.Date
  slot_index          Int
  publish_at          DateTime @db.Timestamptz(6)
  topic_index         Int
  topic               String?
  category            String?
  tags                String[] @default([])
  image_url           String?
  image_prompt        String?
  generated_text      String?
  final_text          String?
  status              String
  approval_message_id BigInt?
  telegram_message_id Int?
  published_link      String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  project Project        @relation(fields: [project_id], references: [id], onDelete: Cascade)
  week    Week           @relation(fields: [week_id], references: [id], onDelete: Cascade)
  channel SocialChannel? @relation(fields: [channel_id], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([week_id])
  @@index([publish_at])
  @@index([status])
  @@map("posts")
}

// ============================================
// System & Logging
// ============================================

model Event {
  id          Int      @id @default(autoincrement())
  ts          DateTime @default(now()) @db.Timestamptz(6)
  entity_type String
  entity_id   Int
  event_type  String
  payload     Json?

  @@map("events")
}

model AgentRun {
  id               Int      @id @default(autoincrement())
  topic            String
  final_score      Int      @default(0)
  total_iterations Int      @default(0)
  created_at       DateTime @default(now())

  iterations AgentIteration[]

  @@map("agent_runs")
}

model AgentIteration {
  id               Int      @id @default(autoincrement())
  run_id           Int
  iteration_number Int
  agent_role       String
  input            String
  output           String
  score            Int?
  critique         String?
  created_at       DateTime @default(now())

  run AgentRun @relation(fields: [run_id], references: [id], onDelete: Cascade)

  @@index([run_id])
  @@map("agent_iterations")
}

// ============================================
// Legacy (to be migrated)
// ============================================

// This will be removed after migration to ProjectSettings
model PromptSettings {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  updated_at DateTime @updatedAt

  @@map("prompt_settings")
}

// ============================================
// Feedback & Customization
// ============================================

model PromptPreset {
  id          Int      @id @default(autoincrement())
  project_id  Int
  role        String   // "post_creator", "topic_creator", etc.
  name        String
  prompt_text String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  project     Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("prompt_presets")
}

model Comment {
  id          Int      @id @default(autoincrement())
  project_id  Int
  entity_type String   // "week", "post"
  entity_id   Int
  text        String
  author_role String   // "user", "assistant" (or specific agent role)
  created_at  DateTime @default(now())

  project     Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id, entity_type, entity_id])
  @@map("comments")
}

model ProviderKey {
  id         Int      @id @default(autoincrement())
  project_id Int
  name       String
  key        String
  provider   String   // "OpenAI", "Anthropic", "Gemini", "Other"
  created_at DateTime @default(now())

  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("provider_keys")
}

model TelegramAccount {
  id             Int      @id @default(autoincrement())
  project_id     Int
  project        Project  @relation(fields: [project_id], references: [id])
  phone_number   String
  session_string String   @db.Text
  api_id         Int
  api_hash       String
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@unique([project_id, phone_number])
  @@map("telegram_accounts")
}

