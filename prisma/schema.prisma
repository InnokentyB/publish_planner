generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Authentication & Users
// ============================================

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  name          String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  memberships ProjectMember[]
  sent_invitations ProjectInvitation[]

  @@map("users")
}

// ============================================
// Projects & Teams
// ============================================

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  members  ProjectMember[]
  channels SocialChannel[]
  weeks    Week[]
  posts    Post[]
  settings ProjectSettings[]
  invitations ProjectInvitation[]
  runs        AgentRun[]

  // v2 Media Orchestrator Relations
  quarter_plans   QuarterPlan[]
  month_arcs      MonthArc[]
  week_packages   WeekPackage[]
  content_items   ContentItem[]
  feedbacks       FeedbackPackage[]

  @@map("projects")
  
  prompt_presets PromptPreset[]
  comments       Comment[]
  provider_keys  ProviderKey[]
  telegram_accounts TelegramAccount[]
}

model ProjectMember {
  id         Int      @id @default(autoincrement())
  project_id Int
  user_id    Int
  role       String // "owner", "editor", "viewer"
  created_at DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@map("project_members")
}

model ProjectInvitation {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  email      String?
  project_id Int
  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  role       String   @default("viewer") // viewer, editor, owner
  created_at DateTime @default(now())
  expires_at DateTime
  created_by Int? // Make created_by optional for now, will be added back if needed

  creator    User?     @relation(fields: [created_by], references: [id], onDelete: SetNull)

  @@map("project_invitations")
  @@index([email])
  @@index([token])
}

model ProjectSettings {
  id         Int      @id @default(autoincrement())
  project_id Int
  key        String
  value      String
  updated_at DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, key])
  @@map("project_settings")
}

// ============================================
// Social Media Channels
// ============================================

model SocialChannel {
  id         Int      @id @default(autoincrement())
  project_id Int
  type       String // "telegram", "vk", "instagram", "twitter", "linkedin"
  name       String
  config     Json // Platform-specific configuration
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  project       Project       @relation(fields: [project_id], references: [id], onDelete: Cascade)
  posts         Post[]
  content_items ContentItem[]

  @@map("social_channels")
}

// ============================================
// Content Planning
// ============================================

model Week {
  id            Int      @id @default(autoincrement())
  project_id    Int
  week_start    DateTime @db.Date
  week_end      DateTime @db.Date
  theme         String
  status        String
  regen_attempt Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  posts   Post[]
  week_memory WeekMemory?

  @@unique([project_id, week_start, week_end])
  @@map("weeks")
}

model Post {
  id                  Int      @id @default(autoincrement())
  project_id          Int
  week_id             Int
  channel_id          Int? // Which social channel to publish to
  slot_date           DateTime @db.Date
  slot_index          Int
  publish_at          DateTime @db.Timestamptz(6)
  topic_index         Int
  topic               String?
  category            String?
  tags                String[] @default([])
  image_url           String?
  image_prompt        String?
  generated_text      String?
  final_text          String?
  status              String
  approval_message_id BigInt?
  telegram_message_id Int?
  published_link      String?
  
  // Sequential Generation Fields
  core_takeaway       String?
  key_points          Json?    // Array of strings
  tool_used           String?
  angle               String?
  critic_score        Int?

  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  project Project        @relation(fields: [project_id], references: [id], onDelete: Cascade)
  week    Week           @relation(fields: [week_id], references: [id], onDelete: Cascade)
  channel SocialChannel? @relation(fields: [channel_id], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([week_id])
  @@index([publish_at])
  @@index([status])
  @@map("posts")
}

model WeekMemory {
  id              Int      @id @default(autoincrement())
  week_id         Int      @unique
  week            Week     @relation(fields: [week_id], references: [id], onDelete: Cascade)
  week_core_summary String // Aggregated summary
  covered_angles  Json     // Array of strings
  used_tools      Json     // Array of strings
  banned_takeaways Json    // Array of strings
  updated_at      DateTime @updatedAt

  @@map("week_memories")
}

// ============================================
// System & Logging
// ============================================

model Event {
  id          Int      @id @default(autoincrement())
  ts          DateTime @default(now()) @db.Timestamptz(6)
  entity_type String
  entity_id   Int
  event_type  String
  payload     Json?

  @@map("events")
}

model AgentRun {
  id        Int      @id @default(autoincrement())
  project_id Int
  project   Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  type      String   // 'week_plan', 'post_write', 'image_gen', 'image_chain', etc.
  agent_role String? // 'visual_architect', 'post_creator', 'critic', etc.
  status    String   // 'success', 'failed'
  input     String?
  prompt    String?
  output    String?
  error     String?
  created_at DateTime @default(now())

  // Legacy fields (optional to match old schema if needed, or removed)
  // topic            String // Removed/Mapped to input
  final_score      Int      @default(0)
  total_iterations Int      @default(0)

  iterations AgentIteration[] // Relation 

  @@map("agent_runs")
  @@index([project_id])
  @@index([type])
}

// Keeping AgentIteration for now but might be unused if we log everything in AgentRun or separate table
model AgentIteration {
  id               Int      @id @default(autoincrement())
  run_id           Int
  iteration_number Int
  agent_role       String
  input            String
  output           String
  score            Int?
  critique         String?
  created_at       DateTime @default(now())

  run AgentRun @relation(fields: [run_id], references: [id], onDelete: Cascade)

  @@index([run_id])
  @@map("agent_iterations")
}

// ============================================
// Legacy (to be migrated)
// ============================================

// This will be removed after migration to ProjectSettings
model PromptSettings {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  updated_at DateTime @updatedAt

  @@map("prompt_settings")
}

// ============================================
// Feedback & Customization
// ============================================

model PromptPreset {
  id          Int      @id @default(autoincrement())
  project_id  Int
  role        String   // "post_creator", "topic_creator", etc.
  name        String
  prompt_text String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  project     Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("prompt_presets")
}

model Comment {
  id          Int      @id @default(autoincrement())
  project_id  Int
  entity_type String   // "week", "post"
  entity_id   Int
  text        String
  author_role String   // "user", "assistant" (or specific agent role)
  created_at  DateTime @default(now())

  project     Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id, entity_type, entity_id])
  @@map("comments")
}

model ProviderKey {
  id         Int      @id @default(autoincrement())
  project_id Int
  name       String
  key        String
  provider   String   // "OpenAI", "Anthropic", "Gemini", "Other"
  created_at DateTime @default(now())

  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("provider_keys")
}

model TelegramAccount {
  id             Int      @id @default(autoincrement())
  project_id     Int
  project        Project  @relation(fields: [project_id], references: [id])
  phone_number   String
  session_string String   @db.Text
  api_id         Int
  api_hash       String
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@unique([project_id, phone_number])
  @@map("telegram_accounts")
}

// ============================================
// v2 Media Orchestrator Models
// ============================================

model QuarterPlan {
  id                 Int      @id @default(autoincrement())
  project_id         Int
  quarter_start      DateTime @db.Date
  quarter_end        DateTime @db.Date
  strategic_goal     String?  // Awareness/Authority/Conversion mix
  primary_pillar     String?
  monetization_focus String?  // none / mini-products / intensive / flagship / club
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  project    Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  month_arcs MonthArc[]

  @@map("quarter_plans")
}

model MonthArc {
  id                Int      @id @default(autoincrement())
  project_id        Int
  quarter_plan_id   Int?
  month             DateTime @db.Date // Representing the month
  arc_theme         String?
  arc_thesis        String?
  key_concepts      Json?    // Array of strings
  planned_longreads Json?    // Habr/VC/Zen plan
  planned_video     Json?    // Video scripts count/plan
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  project       Project       @relation(fields: [project_id], references: [id], onDelete: Cascade)
  quarter_plan  QuarterPlan?  @relation(fields: [quarter_plan_id], references: [id], onDelete: SetNull)
  week_packages WeekPackage[]

  @@map("month_arcs")
}

model WeekPackage {
  id               Int      @id @default(autoincrement())
  project_id       Int
  month_arc_id     Int?
  week_start       DateTime @db.Date
  week_end         DateTime @db.Date
  week_theme       String?
  core_thesis      String?
  audience_focus   String?  // Beginner/Developing/Expert mix
  intent_tag       String?  // Awareness/Authority/Warmup/Launch/Maintenance
  monetization_tie String?  // none / hint / launch etc.
  narrative_arc    Json?    // day1->day7 logic
  cross_links      Json?    // cross link planning
  risks            Json?    // oversimplify, too_deep, repetition
  approval_status  String   @default("draft") // draft/needs_review/approved/rejected
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  project       Project       @relation(fields: [project_id], references: [id], onDelete: Cascade)
  month_arc     MonthArc?     @relation(fields: [month_arc_id], references: [id], onDelete: SetNull)
  content_items ContentItem[]

  @@map("week_packages")
}

model ContentItem {
  id                  Int      @id @default(autoincrement())
  project_id          Int
  week_package_id     Int?
  channel_id          Int?     // Target channel
  type                String   // tg_post, vk_post, habr_article, vc_article, zen_article, video_script
  layer               String?  // azbuka, analyst, pro, community
  title               String?
  brief               String?
  key_points          Json?    // Array of strings
  cta                 String?
  cross_link_to       Json?    // Array of target IDs
  assets              Json?    // Images or diagrams
  draft_text          String?
  status              String   @default("planned") // planned, drafted, revised, approved, scheduled, published, failed
  schedule_at         DateTime? @db.Timestamptz(6)
  quality_report      Json?
  metrics             Json?
  telegram_message_id Int?     // Fallback UI tracking
  published_link      String?  
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  project      Project       @relation(fields: [project_id], references: [id], onDelete: Cascade)
  week_package WeekPackage?  @relation(fields: [week_package_id], references: [id], onDelete: SetNull)
  channel      SocialChannel? @relation(fields: [channel_id], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([week_package_id])
  @@index([status])
  @@map("content_items")
}

model FeedbackPackage {
  id                  Int      @id @default(autoincrement())
  project_id          Int
  period              String   // 'week' or 'month'
  period_start        DateTime @db.Date
  period_end          DateTime @db.Date
  per_channel_metrics Json?
  owner_scores        Json?    // accuracy, style, depth, usefulness
  notes               String?
  recommendations     String?
  applied_changes     String?
  created_at          DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("feedback_packages")
}
